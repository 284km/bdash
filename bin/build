#!/bin/bash

set -ex

export NODE_ENV=production

BUILD_DIR=tmp/build
VERSION=$(node bin/print_version)

rm -rf $BUILD_DIR out
mkdir -p $BUILD_DIR
DIST_DIR=./tmp/build/dist ./node_modules/.bin/webpack
cp -a html db package.json yarn.lock .yarnrc index.js $BUILD_DIR
cd $BUILD_DIR
yarn
cd -

./node_modules/.bin/electron-packager $BUILD_DIR Bdash \
  --asar \
  --overwrite \
  --icon=./assets/icon.icns \
  --platform=darwin \
  --arch=x64 \
  --out=./out \
  --no-prune \
  --app-bundle-id=io.bdash \
  --helper-bundle-id=io.bdash.helper \
  --app-copyright=hokaccha \
  --osx-sign

cd out/Bdash-darwin-x64
zip -qry Bdash-$VERSION-macOS.zip Bdash.app
